<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotaFiscalItemService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdv</a> &gt; <a href="index.source.html" class="el_package">net.originmobi.pdv.service.notafiscal</a> &gt; <span class="el_source">NotaFiscalItemService.java</span></div><h1>NotaFiscalItemService.java</h1><pre class="source lang-java linenums">package net.originmobi.pdv.service.notafiscal;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import net.originmobi.pdv.enumerado.EntradaSaida;
import net.originmobi.pdv.enumerado.notafiscal.NotaFiscalTipo;
import net.originmobi.pdv.enumerado.produto.ProdutoSubstTributaria;
import net.originmobi.pdv.model.NotaFiscal;
import net.originmobi.pdv.model.NotaFiscalItem;
import net.originmobi.pdv.model.NotaFiscalItemImposto;
import net.originmobi.pdv.model.NotaFiscalTotais;
import net.originmobi.pdv.model.Produto;
import net.originmobi.pdv.model.Tributacao;
import net.originmobi.pdv.model.TributacaoRegra;
import net.originmobi.pdv.repository.notafiscal.NotaFiscalItemRepository;
import net.originmobi.pdv.service.ProdutoService;

@Service
<span class="fc" id="L25">public class NotaFiscalItemService {</span>

	@Autowired
	private NotaFiscalItemRepository itemServer;

	@Autowired
	private NotaFiscalItemImpostoService impostos;

	@Autowired
	private NotaFiscalTotaisServer totais;

	@Autowired
	private ProdutoService produtos;

	@Autowired
	private NotaFiscalService notas;

	@Transactional(readOnly = false, propagation = Propagation.REQUIRED)
	public String insere(Long prod, Long codnota, int qtd, NotaFiscalTipo tipo) {
<span class="nc" id="L44">		Optional&lt;Produto&gt; produto = produtos.buscaProduto(prod);</span>
<span class="nc" id="L45">		Optional&lt;NotaFiscal&gt; notaFiscal = notas.busca(codnota);</span>

<span class="nc" id="L47">		verificaRegraDeTributacao(tipo, produto);</span>

<span class="nc" id="L49">		Tributacao tributacao = produto.map(Produto::getTributacao).get();</span>

<span class="nc" id="L51">		Long codImposto = null;</span>
<span class="nc" id="L52">		Long codNotaItem = null;</span>

		// verifica se já tem o item
<span class="nc bnc" id="L55" title="All 2 branches missed.">		for (int i = 0; i &lt; notaFiscal.map(NotaFiscal::getItens).get().size(); i++) {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">			if (notaFiscal.map(NotaFiscal::getItens).get().get(i).getCodProd().equals(prod)) {</span>

<span class="nc" id="L58">				qtd = qtd + notaFiscal.map(NotaFiscal::getItens).get().get(i).getQtd();</span>
<span class="nc" id="L59">				codImposto = notaFiscal.map(NotaFiscal::getItens).get().get(i).getImpostos().getCodigo();</span>
<span class="nc" id="L60">				codNotaItem = notaFiscal.map(NotaFiscal::getItens).get().get(i).getCodigo();</span>
			}
		}

<span class="nc" id="L64">		char origin = tributacao.getRegra().get(0).getCst_csosn().getCst_csosn().toString().charAt(0);</span>
<span class="nc" id="L65">		Double vlTotal = produto.map(Produto::getValor_venda).get() * qtd;</span>
<span class="nc" id="L66">		String uniTribu = produto.map(Produto::getUnidade).get();</span>
<span class="nc" id="L67">		int modBcIcms = produto.map(Produto::getModBcIcms).get().getTipo();</span>
<span class="nc" id="L68">		Double vlUnidade = produto.map(Produto::getValor_venda).get();</span>

		// pega uf do destinatário
<span class="nc" id="L71">		String ufDestinatario = notaFiscal.map(NotaFiscal::getDestinatario).get().getEndereco().getCidade().getEstado()</span>
<span class="nc" id="L72">				.getSigla();</span>

<span class="nc" id="L74">		TributacaoRegra regra = null;</span>

		// pega a regra da tributação do produto que é da mesma uf do destinatário e do
		// mesmo
		// estilo da nota
<span class="nc bnc" id="L79" title="All 2 branches missed.">		for (int i = 0; i &lt; produto.map(Produto::getTributacao).get().getRegra().size(); i++) {</span>
<span class="nc" id="L80">			String ufRegra = produto.map(Produto::getTributacao).get().getRegra().get(i).getUf().getSigla();</span>
<span class="nc" id="L81">			String tipoRegra = produto.map(Produto::getTributacao).get().getRegra().get(i).getTipo().toString();</span>
<span class="nc" id="L82">			String tipoNota = notaFiscal.map(NotaFiscal::getTipo).get().toString();</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">			if (ufRegra.equals(ufDestinatario)) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">				if (tipoRegra.equals(tipoNota)) {</span>
<span class="nc" id="L86">					regra = produto.map(Produto::getTributacao).get().getRegra().get(i);</span>
				}
			}
		}

<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (regra == null)</span>
<span class="nc" id="L92">			throw new RuntimeException(&quot;Nenhuma regra de tributação cadastrada para a UF do destinatário&quot;);</span>

<span class="nc" id="L94">		String cfop = regra.getCfop().getCfop();</span>

		// calcula impostos da nota
<span class="nc" id="L97">		NotaFiscalItemImposto imposto = impostos.calcula(codImposto, vlTotal, regra, origin, modBcIcms);</span>

		// cria item da nota com imposto vinculado
<span class="nc" id="L100">		NotaFiscalItem item = new NotaFiscalItem(prod, qtd, vlTotal, uniTribu, qtd, vlUnidade, notaFiscal.get(),</span>
				imposto, cfop);

		// se for diferente de null, se trata de uma atualização
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (codNotaItem != null)</span>
<span class="nc" id="L105">			item.setCodigo(codNotaItem);</span>

		try {
<span class="nc" id="L108">			itemServer.save(item);</span>
<span class="nc" id="L109">		} catch (Exception e) {</span>
<span class="nc" id="L110">			System.out.println(e);</span>
<span class="nc" id="L111">			throw new RuntimeException(&quot;Erro ao salvar item na nota, chame o suporte&quot;);</span>
<span class="nc" id="L112">		}</span>

		// atualiza totais da nota
<span class="nc" id="L115">		NotaFiscalTotais total = notaFiscal.get().getTotais();</span>
<span class="nc" id="L116">		Long codNota = notaFiscal.get().getCodigo();</span>
<span class="nc" id="L117">		totais.atualiza(codNota, total);</span>

<span class="nc" id="L119">		return &quot;ok&quot;;</span>
	}

	@Transactional(readOnly = false, propagation = Propagation.REQUIRED)
	public void remove(Long notaitem, Long codnota) {
		
		try {
<span class="nc" id="L126">			itemServer.deleteById(notaitem);</span>
<span class="nc" id="L127">		} catch (Exception e) {</span>
<span class="nc" id="L128">			System.out.println(e);</span>
<span class="nc" id="L129">			throw new RuntimeException(&quot;Erro ao tentar remover o item da nota, chame o suporte&quot;);</span>
<span class="nc" id="L130">		}</span>
		
<span class="nc" id="L132">		Optional&lt;NotaFiscal&gt; notaFiscal = notas.busca(codnota);</span>
<span class="nc" id="L133">		NotaFiscalTotais total = notaFiscal.get().getTotais();</span>
<span class="nc" id="L134">		totais.atualiza(codnota, total);</span>
<span class="nc" id="L135">	}</span>

	private void verificaRegraDeTributacao(NotaFiscalTipo tipo, Optional&lt;Produto&gt; produto) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (!produto.isPresent())</span>
<span class="nc" id="L139">			throw new RuntimeException(&quot;Nenhum produto encontrado, favor verifique&quot;);</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (!produto.map(Produto::getTributacao).isPresent())</span>
<span class="nc" id="L142">			throw new RuntimeException(&quot;Produto sem tributação, favor verifique&quot;);</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (produto.map(Produto::getNcm).get().isEmpty())</span>
<span class="nc" id="L145">			throw new RuntimeException(&quot;Produto sem código NCM, favor verifique&quot;);</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">		if (produto.map(Produto::getSubtributaria).get().ordinal() == ProdutoSubstTributaria.SIM.ordinal()</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">				&amp;&amp; produto.map(Produto::getCest).get().isEmpty())</span>
<span class="nc" id="L149">			throw new RuntimeException(&quot;Produto de substituição tributária sem código CEST, favor verifique&quot;);</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (produto.map(Produto::getUnidade).get().isEmpty())</span>
<span class="nc" id="L152">			throw new RuntimeException(&quot;Produto sem unidade, favor verifique&quot;);</span>

		// verifica se a tributação do produto possue regra para o estilo de nota
		// selecionado
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (tipo.equals(NotaFiscalTipo.SAIDA)) {</span>
<span class="nc" id="L157">			int aux = 0;</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">			for (int i = 0; i &lt; produto.map(Produto::getTributacao).get().getRegra().size(); i++) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">				if (produto.map(Produto::getTributacao).get().getRegra().get(i).getTipo().equals(EntradaSaida.SAIDA))</span>
<span class="nc" id="L160">					aux = aux + 1;</span>
			}

<span class="nc bnc" id="L163" title="All 2 branches missed.">			if (aux == 0)</span>
<span class="nc" id="L164">				throw new RuntimeException(&quot;Tributação sem regra de saída, verifique&quot;);</span>
<span class="nc" id="L165">		} else {</span>
<span class="nc" id="L166">			int aux = 0;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			for (int i = 0; i &lt; produto.map(Produto::getTributacao).get().getRegra().size(); i++) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (produto.map(Produto::getTributacao).get().getRegra().get(i).getTipo().equals(EntradaSaida.ENTRADA))</span>
<span class="nc" id="L169">					aux = aux + 1;</span>
			}

<span class="nc bnc" id="L172" title="All 2 branches missed.">			if (aux == 0)</span>
<span class="nc" id="L173">				throw new RuntimeException(&quot;Tributação sem regra de entrada, verifique&quot;);</span>
		}
<span class="nc" id="L175">	}</span>

	public List&lt;Object&gt; buscaItensNota(Long codigo) {
<span class="nc" id="L178">		return itemServer.findByNotaFiscalCodigoEquals(codigo);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
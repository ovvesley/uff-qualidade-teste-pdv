<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProdutoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdv</a> &gt; <a href="index.source.html" class="el_package">net.originmobi.pdv.service</a> &gt; <span class="el_source">ProdutoService.java</span></div><h1>ProdutoService.java</h1><pre class="source lang-java linenums">package net.originmobi.pdv.service;

import java.sql.Date;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import net.originmobi.pdv.enumerado.EntradaSaida;
import net.originmobi.pdv.enumerado.produto.ProdutoControleEstoque;
import net.originmobi.pdv.enumerado.produto.ProdutoSubstTributaria;
import net.originmobi.pdv.filter.ProdutoFilter;
import net.originmobi.pdv.model.Produto;
import net.originmobi.pdv.repository.ProdutoRepository;

@Service
<span class="fc" id="L21">public class ProdutoService {</span>

	@Autowired
	private ProdutoRepository produtos;

	@Autowired
	private VendaProdutoService vendaProdutos;

<span class="fc" id="L29">	private LocalDate dataAtual = LocalDate.now();</span>

	public List&lt;Produto&gt; listar() {
<span class="nc" id="L32">		return produtos.findAll();</span>
	}
	
	public List&lt;Produto&gt; listaProdutosVendaveis() {
<span class="nc" id="L36">		return produtos.produtosVendaveis();</span>
	}

	public Produto busca(Long codigoProduto) {
<span class="nc" id="L40">		return produtos.findByCodigoIn(codigoProduto);</span>
	}

	public Optional&lt;Produto&gt; buscaProduto(Long codigo) {
<span class="nc" id="L44">		return produtos.findById(codigo);</span>
	}

	public Page&lt;Produto&gt; filter(ProdutoFilter filter, Pageable pageable) {
<span class="nc bnc" id="L48" title="All 2 branches missed.">		String descricao = filter.getDescricao() == null ? &quot;%&quot; : filter.getDescricao();</span>
<span class="nc" id="L49">		return produtos.findByDescricaoContaining(descricao, pageable);</span>
	}

	public String merger(Long codprod, Long codforne, Long codcategoria, Long codgrupo, int balanca, String descricao,
			Double valorCusto, Double valorVenda, java.util.Date dataValidade, String controleEstoque, String situacao,
			String unitario, ProdutoSubstTributaria subtribu, String ncm, String cest, Long tributacao, Long modbc, String vendavel) {

<span class="nc bnc" id="L56" title="All 2 branches missed.">		if (codprod == 0) {</span>
			try {
<span class="nc" id="L58">				produtos.insere(codforne, codcategoria, codgrupo, balanca, descricao, valorCusto, valorVenda,</span>
<span class="nc" id="L59">						dataValidade, controleEstoque, situacao, unitario, subtribu.ordinal(), Date.valueOf(dataAtual),</span>
						ncm, cest, tributacao, modbc, vendavel);
<span class="nc" id="L61">			} catch (Exception e) {</span>
<span class="nc" id="L62">				System.out.println(e.getMessage());</span>
<span class="nc" id="L63">				return &quot;Erro a cadastrar produto, chame o suporte&quot;;</span>
<span class="nc" id="L64">			}</span>
		} else {

			try {
<span class="nc" id="L68">				produtos.atualiza(codprod, codforne, codcategoria, codgrupo, balanca, descricao, valorCusto, valorVenda,</span>
<span class="nc" id="L69">						dataValidade, controleEstoque, situacao, unitario, subtribu.ordinal(), ncm, cest, tributacao,</span>
						modbc, vendavel);

<span class="nc" id="L72">				return &quot;Produto atualizado com sucesso&quot;;</span>
<span class="nc" id="L73">			} catch (Exception e) {</span>
<span class="nc" id="L74">				System.out.println(e.getMessage());</span>
<span class="nc" id="L75">				return &quot;Erro a atualizar produto, chame o suporte&quot;;</span>
			}

		}

<span class="nc" id="L80">		return &quot;Produdo cadastrado com sucesso&quot;;</span>
	}

	@SuppressWarnings(&quot;static-access&quot;)
	public void movimentaEstoque(Long codvenda, EntradaSaida tipo) {
<span class="nc" id="L85">		List&lt;Object[]&gt; resultado = vendaProdutos.buscaQtdProduto(codvenda);</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">		for (int i = 0; i &lt; resultado.size(); i++) {</span>
<span class="nc" id="L88">			Long codprod = Long.decode(resultado.get(i)[0].toString());</span>
<span class="nc" id="L89">			int qtd = Integer.parseInt(resultado.get(i)[1].toString());</span>

<span class="nc" id="L91">			Produto produto = produtos.findByCodigoIn(codprod);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (produto.getControla_estoque().equals(ProdutoControleEstoque.SIM)) {</span>

				// estoque atual do produto
<span class="nc" id="L96">				int qtd_estoque = produtos.saldoEstoque(codprod);</span>
<span class="nc" id="L97">				String origem_operacao = &quot;Venda &quot; + codvenda.toString();</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">				if (qtd &lt;= qtd_estoque) {</span>
<span class="nc" id="L100">					produtos.movimentaEstoque(codprod, tipo.SAIDA.toString(), qtd, origem_operacao,</span>
<span class="nc" id="L101">							Date.valueOf(dataAtual));</span>
				} else {
<span class="nc" id="L103">					throw new RuntimeException(</span>
							&quot;O produto de código &quot; + codprod + &quot; não tem estoque suficiente, verifique&quot;);
				}
<span class="nc" id="L106">			} else {</span>
<span class="nc" id="L107">				System.out.println(&quot;Produto não controla estoque&quot;);</span>
			}
		}

<span class="nc" id="L111">	}</span>
	
	public void ajusteEstoque(Long codprod, int qtd, EntradaSaida tipo, String origem_operacao, Date data_movimentacao) {
<span class="nc" id="L114">		Produto produto = produtos.findByCodigoIn(codprod);</span>
		
<span class="nc bnc" id="L116" title="All 2 branches missed.">		if (produto.getControla_estoque().equals(ProdutoControleEstoque.NAO))</span>
<span class="nc" id="L117">			throw new RuntimeException(&quot;O produto de código &quot; + codprod + &quot; não controla estoque, verifique&quot;);</span>
		
<span class="nc" id="L119">		produtos.movimentaEstoque(codprod, tipo.toString(), qtd, origem_operacao, data_movimentacao);</span>
		
<span class="nc" id="L121">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>